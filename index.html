
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>log(1)</title>
  <meta name="author" content="Tuz">

  
  <meta name="description" content="Author: Tuz (&#121;&#x6f;&#117;&#110;&#x67;&#116;&#x72;&#105;&#112;&#115;&#64;&#x6d;&#97;&#x69;&#108;&#x2e;&#x63;&#x6f;&#109;) Date: 06.21.2013 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://logit.me">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="log(1)" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34373738-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">log(1)</a></h1>
  
    <h2>somewhere to keep mind</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:logit.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about/">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/24/ability-system-design/">Ability-system-design</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-24T08:59:00+08:00" pubdate data-updated="true">Jun 24<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/06/24/ability-system-design/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Author</strong>: Tuz (<a href="&#109;&#97;&#x69;&#x6c;&#x74;&#111;&#x3a;&#x79;&#111;&#x75;&#x6e;&#103;&#x74;&#x72;&#x69;&#x70;&#x73;&#x40;&#109;&#97;&#x69;&#x6c;&#46;&#99;&#x6f;&#109;">&#121;&#x6f;&#117;&#110;&#x67;&#116;&#x72;&#105;&#112;&#115;&#64;&#x6d;&#97;&#x69;&#108;&#x2e;&#x63;&#x6f;&#109;</a>)</p>

<br>


<p><strong>Date</strong>: 06.21.2013</p>

<h2>技能脚本系统设计</h2>

<h3>概述</h3>

<p>针对现有技能系统发送消息过大, C++和lua交互频繁, 客户端功能服务器化, 触发器抽象粒度太小, 数据更新同步等问题进行脚本系统重构优化. 通过分析现有技能实现抽象出技能框架(技能引擎), 实现控制基本技能流程, 同时加入事件进制, 如攻击, 受伤等事件, 进而希望能够丰富技能同时使天赋的实现比较优雅.</p>

<h3>技能系统文件系统组织</h3>

<ul>
<li>data (配置文件所在)

<ul>
<li>skill (技能实例配置)</li>
<li>buff (BUFF实例配置)</li>
<li>talent (天赋实例配置)</li>
<li>metadata (基本数据/元数据配置)

<ul>
<li>chapion.lua (各个职业基本数值配置)</li>
<li>monster.lua (各个类别怪物基本数值配置)</li>
<li>level.lua  (职业等级基本数值配置)</li>
<li>skill.lua  (各个技能基本数值配置)</li>
</ul>
</li>
</ul>
</li>
<li>engine (技能框架,控制技能实例的运行及包含技能的公共函数等)</li>
<li>lib (与具体游戏逻辑无关的公共库模块,包括基本计算几何计算等)</li>
<li>skill (各个技能实例执行逻辑文件)</li>
<li>buff (各个BUFF实例执行逻辑文件)</li>
<li>talent (各个天赋实例执行逻辑)</li>
<li>ai (怪物Ai逻辑)</li>
<li>test (模块测试例程)</li>
</ul>


<h3>系统基本结构</h3>

<p>技能系统主要分为如下几个部分:</p>

<ol>
<li>事件系统: 由C++实现事件管理系统并提供给lua层注册事件及抛出事件的接口函数, C++每tick处理每个对象的事件队列；</li>
<li>属性更新系统: 由C++实现对象属性更新机制并提供给lua层压入需要更新属性集的借口函数以实现lua上层逻辑勿需关系属性同步消息的发送；</li>
<li>对象属性管理系统: 在lua层实现玩家对象及怪物对象属性及包含的技能属性的管理以减少lua访问对象属性时与C++层的交互调用；</li>
<li>技能引擎(框架): 抽象出技能的公共部分, 将技能分解为几个阶段以控制技能实例的运行.</li>
</ol>


<h3>事件系统</h3>

<p><img src="/images/ability-design/eventbox.png" alt="eventbox" /></p>

<p>由C++层在当前触发器基础之上(改变当前触发器使用方式)封装具体类型的游戏事件系统, 每个游戏对象有自己的事件队列, 对象在Lua层通过接口函数可以注册事件或者在技能引擎模块中通过接口函数发送产生的游戏事件.</p>

<p>事件的组成:</p>

<ol>
<li><p>外部事件, 独立于技能体系, 不依赖于特定的技能产生, 主要由系统功能产生的, 主要包括:</p>

<ol>
<li>时间事件: 定时器触发的事件</li>
<li>碰撞事件: 由移动碰撞产生的事件</li>
</ol>
</li>
<li><p>内部事件, 由技能各个模块执行过程中产生的, 主要有:</p>

<ol>
<li>技能释放和被释放事件</li>
<li>攻击和被攻击事件</li>
<li>暴击和被暴击事件</li>
<li>死亡和被击杀事件</li>
<li>闪避和被闪避事件</li>
</ol>
</li>
</ol>


<h3>属性更新系统</h3>

<p>C++层实现一套脏属性更新机制, 提供给lua层添加更新属性请求的接口函数(该函数主要由脚本底层调用, 上层逻辑不直接调用), 属性更新系统定时或即时的编码变化的属性值给客户端.</p>

<h3>对象属性管理系统</h3>

<p>C++层创建对象后将会在lua层创建对应的管理对象(包含需要在lua层管理的对象属性, 技能及BUFF), 可是说是取消现有PT访问的进制, 但可以保持现有PT访问的方式实现上层对PT访问的透明性. lua中对象继承关系如下图所示:</p>

<p><img src="/images/ability-design/objs.png" alt="objs" /></p>

<p>其中Creature中skills包含该对象所有技能实例的属性集, 其技能属性集继承对应的技能配置表, 当技能实例发生修改属性时该技能属性集会有对应新的属性值以实现COW机制, 例如:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='lua'><span class='line'>  <span class="k">function</span> <span class="nf">inherit</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span><span class="n">super</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">setmetatable</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span>
</span><span class='line'>      <span class="p">{</span> <span class="n">__index</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
</span><span class='line'>             <span class="kd">local</span> <span class="n">ret</span><span class="o">=</span><span class="n">super</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span class='line'>             <span class="n">sub</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">ret</span>
</span><span class='line'>             <span class="k">return</span> <span class="n">ret</span>
</span><span class='line'>      <span class="k">end</span> <span class="p">}</span> <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">b</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">inherit</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="c1">-- b继承a两个成语x,y</span>
</span><span class='line'>  <span class="n">b</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">3</span>       <span class="c1">-- b将会有独立于a的成员x, 其值为3</span>
</span></code></pre></td></tr></table></div></figure>


<p>对象身上BUFF实例属性集管理与技能类似.</p>

<h3>技能引擎</h3>

<p>从客户端表现上来看,技能可以看成是一个连续的, 有时间限制的事件序列. 在这个时间线上, 会出现一些关键事件, 例如伤害, 发射飞弹或其他, 所以这些技能事件才是该技能真正需要在客户端－服务器, 客户端－客户端之间传递的信息, 每个客户端都可以根据这些关键信息还原出技能的连续信号(模拟技能过程). 该技能引擎由客户端的消息进行驱动, 引擎通过发送技能事件给客户端, 客户端通过收到的技能事件决定客户端的技能表现(如吟唱, 特效及播放动作等). 服务器端每个技能实例由基本的OnEnter(), OnFire()及OnEnd()等回调函数组成.</p>

<p>服务器端将技能流程主要分解为三个阶段:</p>

<ol>
<li>技能开始(Enter): 施法前判定,回调技能实例OnEnter()及产生OnEnter事件通知客户端；</li>
<li>技能执行(Fire): 技能释放过程,根据技能实例类型获取目标对象并回调技能实例OnFire()及产生OnFire事件通知客户端；</li>
<li>技能结束(End): 技能结束过程,回调技能实例OnEnd()及产生OnEnd事件通知客户端.</li>
</ol>


<p>客户端技能流程与服务器类似:</p>

<ol>
<li>技能触发阶段(Enter): 有玩家输入触发执行, 产生Enter事件请求服务器；</li>
<li>技能开始(OnEnter): 客户端接收OnEnter事件执行进行吟唱, 动作播放及特效绑定等；</li>
<li>技能释放(OnFire): 客户端接收OnFire事件执行伤害数值显示, 动作播放及特效绑定等；</li>
<li>技能结束(OnEnd): 客户端接收OnEnd事执行技能结束清理逻辑, 如特性清理, 动作重置等.</li>
</ol>


<p>技能实例执行时序图如下所示:</p>

<p><img src="/images/ability-design/skill_engine.png" alt="skill_engine" /></p>

<p>Detail of Engine:</p>

<p><img src="/images/ability-design/engine-detail.png" alt="engine_detail" /></p>

<p>服务器端技能实例主要包含:</p>

<ol>
<li>OnAdd() 当技能被添加到对象身上时执行</li>
<li>OnDel() 当技能从对象身上移除时执行</li>
<li>OnUpgrade() 当技能升级时执行</li>
<li>OnEnter()</li>
<li>OnFire()</li>
<li>OnEnd()</li>
</ol>


<h3>天赋系统</h3>

<p>天赋可以归结为一种特殊的技能, 所以天赋实例与技能实例有着相同的组成成份. 天赋的驱动由技能引擎产生的各种事件进行驱动(如技能CD前后事件, 攻击前后事件, 资源消耗前后事件及伤害结算前后事件等).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/03/lua-csv/">Parsing CSV Files in Lua</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-03T16:14:00+08:00" pubdate data-updated="true">Jun 3<span>rd</span>, 2013</time>
        
         | <a href="/blog/2013/06/03/lua-csv/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>code snippet for parsing csv files in lua, mark it(from <a href="http://lua-users.org/wiki/LuaCsv">http://lua-users.org/wiki/LuaCsv</a>):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='lua'><span class='line'><span class="k">function</span> <span class="nf">ParseCSVLine</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">sep</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>  <span class="n">sep</span> <span class="o">=</span> <span class="n">sep</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="s">,&#39;</span>
</span><span class='line'>  <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">pos</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">&quot;</span><span class="p">)</span> <span class="k">then</span> <span class="k">break</span> <span class="k">end</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="s">&quot;&#39;</span><span class="p">)</span> <span class="k">then</span>
</span><span class='line'>          <span class="c1">-- quoted value (ignore separator within)</span>
</span><span class='line'>          <span class="kd">local</span> <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
</span><span class='line'>          <span class="k">repeat</span>
</span><span class='line'>              <span class="kd">local</span> <span class="n">startp</span><span class="p">,</span><span class="n">endp</span> <span class="o">=</span> <span class="nb">string.find</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">^%b&quot;&quot;&#39;</span><span class="p">,</span><span class="n">pos</span><span class="p">)</span>
</span><span class='line'>              <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">..</span><span class="nb">string.sub</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">startp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">endp</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>              <span class="n">pos</span> <span class="o">=</span> <span class="n">endp</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>              <span class="n">c</span> <span class="o">=</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">pos</span><span class="p">)</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="s">&quot;&#39;</span><span class="p">)</span> <span class="k">then</span> <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">..</span><span class="s1">&#39;</span><span class="s">&quot;&#39;</span> <span class="k">end</span>
</span><span class='line'>              <span class="c1">-- check first char AFTER quoted string, if it is another</span>
</span><span class='line'>              <span class="c1">-- quoted string without separator, then append it</span>
</span><span class='line'>              <span class="c1">-- this is the way to &quot;escape&quot; the quote char in a quote. example:</span>
</span><span class='line'>              <span class="c1">--   value1,&quot;blub&quot;&quot;blip&quot;&quot;boing&quot;,value3  will result in blub&quot;blip&quot;boing  for the middle</span>
</span><span class='line'>          <span class="k">until</span> <span class="p">(</span><span class="n">c</span> <span class="o">~=</span> <span class="s1">&#39;</span><span class="s">&quot;&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">table.insert</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">txt</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">assert</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">sep</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>      <span class="k">else</span> 
</span><span class='line'>          <span class="c1">-- no quotes used, just look for the first separator</span>
</span><span class='line'>          <span class="kd">local</span> <span class="n">startp</span><span class="p">,</span><span class="n">endp</span> <span class="o">=</span> <span class="nb">string.find</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">sep</span><span class="p">,</span><span class="n">pos</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">startp</span><span class="p">)</span> <span class="k">then</span>
</span><span class='line'>              <span class="nb">table.insert</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="nb">string.sub</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">startp</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span class='line'>              <span class="n">pos</span> <span class="o">=</span> <span class="n">endp</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>              <span class="c1">-- no separator found -&gt; use rest of string and terminate</span>
</span><span class='line'>              <span class="nb">table.insert</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="nb">string.sub</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">pos</span><span class="p">))</span>
</span><span class='line'>              <span class="k">break</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">res</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/31/reverse-proxy/">ssh+nginx反向代理访问内网Web Service</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-31T14:14:00+08:00" pubdate data-updated="true">May 31<span>st</span>, 2013</time>
        
         | <a href="/blog/2013/05/31/reverse-proxy/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在一般的网络环境下，互联网无法直接访问到局域网的计算机，如果你想在家里访问公司局域网的计算机或者在公司想访问家里的计算机，那么需要借助特定的工具，这里以ssh+nginx反向代理访问局域网计算机的web服务器为例。
假定你有一台具有公网IP的服务器S1(211.83.241.83)以及一台在局域网开启web服务的计算机S2(172.16.18.3)，如下图所示:</p>

<p><img src="/images/reverse-proxy-net.png" alt="reverse-proxy-net.png" /></p>

<h3>概述</h3>

<p>S2通过ssh连接S1开启反向隧道，它在服务器上开启一个监听端口12345同时在将该端口影射在本地web服务端口8080上，S1上开启ngix反向代理将80端口代理到12345上，用户通过访问S1时nginx将请求代理到12345端口上，ssh通过建立好的隧道将请求传输到S2，S2从隧道中接收请求并转发到监听8080端口的web服务，并将结果通过隧道返回给S1，S1从隧道获取结果返回给nginx，nginx再将请求结果返回给用户，从而访问到局域网内的web服务。</p>

<h3>配置</h3>

<ol>
<li>在你所需要访问的web service的内网服务器S2上执行以下命令:</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh -f -N -R &lt;服务器端口>:&lt;本地IP>:&lt;本地端口> &lt;服务器地址></span></code></pre></td></tr></table></div></figure>


<p>例如:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh -f -N -L 12345:127.0.0.1:8080 211.83.241.83</span></code></pre></td></tr></table></div></figure>


<p>该命令执行后会将远程服务器S1(211.83.241.83:12345)映射到本地端口8080</p>

<ol>
<li><p>在公网服务器S1上开启nginx反向代理:</p>

<p> 例如:</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server {
</span><span class='line'>        listen       80;
</span><span class='line'>        server_name  localhost;
</span><span class='line'>        location / {
</span><span class='line'>            proxy_pass  http://127.0.0.1:12345;
</span><span class='line'>            proxy_set_header   Host             $host:80;
</span><span class='line'>            proxy_set_header   X-Real-IP        $remote_addr;
</span><span class='line'>            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
</span><span class='line'>            proxy_set_header Via    "nginx";
</span><span class='line'>        }
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/29/ability-analyze-report/">技能脚本系统实现分析</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-29T16:49:00+08:00" pubdate data-updated="true">May 29<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/05/29/ability-analyze-report/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Author</strong>: Tuz (<a href="&#x6d;&#97;&#x69;&#x6c;&#116;&#x6f;&#58;&#x79;&#x6f;&#117;&#x6e;&#x67;&#116;&#114;&#x69;&#112;&#x73;&#x40;&#x6d;&#x61;&#x69;&#108;&#46;&#99;&#x6f;&#x6d;">&#121;&#111;&#x75;&#110;&#103;&#116;&#114;&#x69;&#x70;&#x73;&#64;&#x6d;&#97;&#x69;&#108;&#46;&#99;&#111;&#109;</a>)</p>

<br>


<p><strong>Date</strong>: 05.20.2013</p>

<h3>Contents</h3>

<ul>
<li><a href="#overview">概述</a></li>
<li><a href="#skill_mgr_cpp">服务器底层<code>(C++)</code>技能管理分析</a>

<ul>
<li><a href="#cpp_classess">技能C++层次类关系图</a></li>
<li><a href="#base_skill_proc">技能释放基本流程</a></li>
<li><a href="#enable_talent_proc">天赋开启流程</a></li>
</ul>
</li>
<li><a href="#skill_mgr_lua">脚本层技能管理分析</a></li>
<li><a href="#script_netmsg">脚本中网络通信</a></li>
<li><a href="#zhan_skill">战职业技能分析</a>

<ul>
<li><a href="#zhan_q">Q-连刺</a></li>
<li><a href="#zhan_w">W-旋风</a></li>
<li><a href="#zhan_e">E-怒吼</a></li>
<li><a href="#zhan_r">R-冲抢</a></li>
<li><a href="#zhan_a">战普通攻击技能</a></li>
</ul>
</li>
<li><a href="#sheng_skill">圣职业技能分析</a>

<ul>
<li><a href="#sheng_q">Q-滑步</a>

<ul>
<li><a href="#sheng_q1">天赋-距离</a></li>
<li><a href="#sheng_q2">天赋-快速准备</a></li>
<li><a href="#sheng_q3">天赋-斩杀</a></li>
</ul>
</li>
<li><a href="#sheng_w">W-三向分身</a>

<ul>
<li><a href="#sheng_w1">天赋-增强</a></li>
<li><a href="#sheng_w2">天赋-鬼步</a></li>
<li><a href="#sheng_w3">天赋-反击</a></li>
</ul>
</li>
<li><a href="#sheng_e">E-连切</a>

<ul>
<li><a href="#sheng_e1">天赋-影增强</a></li>
<li><a href="#sheng_e2">天赋-嗜血</a></li>
<li><a href="#sheng_e3">天赋-破绽</a></li>
</ul>
</li>
<li><a href="#sheng_r">R-绝影斩</a>

<ul>
<li><a href="#sheng_r1">天赋-追击强化</a></li>
<li><a href="#sheng_r2">天赋-饮血</a></li>
<li><a href="#sheng_r3">天赋-反刃</a></li>
</ul>
</li>
<li><a href="#passive_talent">被动天赋</a>

<ul>
<li><a href="#sheng_b1">会心一击</a></li>
<li><a href="#sheng_b2">替身术</a></li>
<li><a href="#sheng_b3">残影精通</a></li>
</ul>
</li>
</ul>
</li>
</ul>


<hr />

<h2 id="overview">概述</h2>


<p>为了更好的优化技能脚本模块，本文主要针对职业基本属性配置、技能属性配置、技能脚本实现及与其相关联的BUFF、天赋等模块进行梳理分析。</p>

<h2 id="skill_mgr_cpp">服务器底层(C++)技能的管理分析</h2>




<h3 id="cpp_classess">技能C++层次类关系图</h3>


<p><img src="/images/ability-analyze-report/classes_relation.png" alt="C++类关系图" /></p>

<h3 id="base_skill_proc">技能释放基本流程</h3>


<p>技能释放由客户端输入驱动通过网络模块发送消息，服务器收到消息后查找到技能对应释放对象调用脚本系统执行对应技能的入口函数， 其执行过程如下序列图所示:
<img src="/images/ability-analyze-report/ability_flow.png" alt="技能释放序列图" /></p>

<h3 id="enable_talent_proc">天赋开启流程</h3>


<p>在客户端天赋界面点选各个技能天赋确定后发消息通知服务器，服务器解析消息根据技能id及天赋id调用对应技能天赋的初始化lua函数(当玩家登陆进入服务器时也会根据天赋记录调用初始化函数)，执行序列图如下所示:</p>

<p><img src="/images/ability-analyze-report/enable_talent_proc.png" alt="天赋开启流程" /></p>

<p><em>BTW: 当前天赋系统结构不能非常简单完美的实现重置天赋，那些根据额外的天赋属性触发的天赋可以简单的清理玩家对象的技能属性列表，但对于那些被动天赋很多都是挂触发器(Trigger)实现的，这需要删除触发器，进而涉及到触发器ID的保存问题</em></p>

<p>技能中天赋逻辑参见<a href="#sheng_skill">圣技能分析中天赋相关内容</a></p>

<h2 id="skill_mgr_lua">脚本层技能管理分析</h2>


<p>当前脚本系统中根据功能大致可分为以下几个模块:</p>

<ol>
<li>职业基本属性配置模块(classAttTable): 通过lua table配置各个职业的基本数值属性、主要有基础HP、基础MP、基础护甲、基础法抗、基础攻击力，基础法术强度等与技能计算相关的属性，配置示例如下：</li>
</ol>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='lua'><span class='line'>    <span class="n">ClassAttTable</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">MaxHpBase</span> <span class="o">=</span> <span class="mi">550</span><span class="p">,</span> <span class="n">ArmorBase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SpellResistanceBase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PhysicalPowerBase</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">CriticalRating</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                <span class="n">CriticalDamageIncrease</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ArmorPenetration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ArmorPenetrationRatio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AttackInterval</span> <span class="o">=</span> <span class="mi">900</span><span class="p">,</span>
</span><span class='line'>                <span class="n">AttackTimeBase</span> <span class="o">=</span> <span class="mf">1.11</span><span class="p">,</span> <span class="n">SpellPowerBase</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">SpellPenetration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SpellPenetrationRatio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SpellCDReduce</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                <span class="n">MaxMpBase</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">MpRecoverBase</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">HpRecover</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">SpellToughness</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HitProbability</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DodgeProbability</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ViewRange</span> <span class="o">=</span> <span class="mi">12</span><span class="p">},</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>目前该配置由策划填写的csv表格通过工具生成lua文件所得。</p>

<ol>
<li><p>技能数值属性(skillAttTable): 通过lua table配置各个技能的基本数值属性, 包括技能消耗、技能CD时间、技能断定距离、技能伤害类型及技能伤害，该配置与职业基本属性配置一样通过csv表格由工具生成lua文件所得；</p></li>
<li><p>技能公共模块(serverSkillPublic): 主要包括技能流程中经常使用到的公共函数，包括施法前检查函数skillSelfOK, skillTargetOK，吟唱函数skillIncant以及BUFF公共函数等;</p></li>
<li><p>技能属性配置模块(skill_propertyset): 配置初始化各个技能的所有属性, 其中技能伤害，技能CD等基础数值属性直接引用技能数值属性配置，技能配置中通过大量调用接口函数InitSkillProperty实现;</p></li>
<li><p>BUFF数值配置模块(buff_propertyset): 配置方式与技能属性配置相同均通过InitSkillProperty配置</p></li>
<li><p>技能逻辑模块(skill): 各个技能的具体的执行逻辑，例如战普通攻击技能脚本逻辑/skills/skill_11001.lua</p></li>
<li><p>BUFF逻辑模块(buff)</p></li>
<li><p>天赋系统模块(genius): 包括天赋属性配置及天赋执行逻辑函数, 目前我们有些的天赋是嵌入技能脚本中执行的;</p></li>
<li><p>数值计算模块(math): 主要包括技能消耗计算，技能伤害计算等与数值相关的计算模块;</p></li>
<li><p>怪物AI模块(AI): 驱动怪物行为逻辑.</p></li>
</ol>


<p>这些模块通过脚本逻辑或者BUFF逻辑组织起来组成完成的技能逻辑，下面具体分析战及圣各个技能脚本实现。</p>

<h2 id="script_netmsg">脚本中网络通信</h2>


<p>目前项目里lua脚本与客户端的通信可以通过C++提供的功能接口进行间接通信，还可以通过调用C++提供的接口RunClientScript与客户端进行直接通信，该函数功能是通过发送客户端定义好的lua函数名及序列化好的参数调用客户端的逻辑脚本，目前脚本中大量使用RunClientScript主要:</p>

<ol>
<li>怪物AI中同步怪物属性及动作;</li>
<li>副本相关逻辑脚本;</li>
<li><p>技能脚本中控制技能特效、发送技能伤害及资源消耗;</p>

<ul>
<li><p>发送命中伤害显示playHitVisToClient()</p>

<p>  <img src="/images/ability-analyze-report/playHitVisToClient.png" alt="playHitVisToClient" /></p></li>
<li><p>向客户端发送某目标免疫、闪避、抵抗的消息playStateInvalidToClient()</p>

<p>  <img src="/images/ability-analyze-report/playStateInvalidToClient.png" alt="playStateInvalidToClient" /></p></li>
<li><p>skillMessageToClient(主要是控制动作特效)skillMessageToClient()</p>

<p>  <img src="/images/ability-analyze-report/skillMessageToClient.png" alt="skillMessageToClient" /></p></li>
<li><p>消耗资源，同时发送相关显示消息给客户端resCostAndMsgToClient()</p>

<p>  <img src="/images/ability-analyze-report/resCostAndMsgToClient.png" alt="resCostAndMsgToClient" /></p></li>
</ul>
</li>
<li><p>数值计算模块中更新角色属性(playerAttCaculate).</p>

<p> <img src="/images/ability-analyze-report/playerAttCaculate.png" alt="playerAttCaculate" /></p></li>
</ol>


<h2 id="zhan_skill">战职业技能分析</h2>


<p>战技能大都通过SkillStage技能属性控制技能的每一阶段的逻辑执行, 下面具体看看每个技能的执行序列图。</p>

<h3 id="zhan_q">Q-连刺</h3>


<ul>
<li><p>需求:</p>

<p>  连续对前面扇形范围内全部敌人造成数次伤害，之后，对更大范围内敌人造成一次高伤害但自身有收招硬直的攻击</p></li>
<li><p>序列图:</p>

<p>  <img src="/images/ability-analyze-report/zhan_11002.png" alt="11003序列图" /></p></li>
</ul>


<h3 id="zhan_w">W-旋风</h3>


<ul>
<li><p>需求:</p>

<p>  前冲一小段距离，并连续打击周围的敌人，可再次点击热键来释放终结技</p></li>
<li><p>序列图:</p>

<p>  <img src="/images/ability-analyze-report/zhan_11003.png" alt="11003序列图" /></p></li>
</ul>


<h3 id="zhan_e">E-怒吼</h3>


<ul>
<li><p>需求:</p>

<p>  技能施放后，战士发出一声怒吼，以自身为中心x格（暂定6）范围内敌人减速y%（暂定40%），持续z秒（暂定3</p></li>
<li><p>时序图:</p>

<p>  <img src="/images/ability-analyze-report/zhan_11004.png" alt="11003序列图" /></p></li>
</ul>


<h3 id="zhan_r">R-冲枪</h3>


<ul>
<li><p>需求:</p>

<p>  对方向前冲，行径中对前面区域多次造成伤害并击退，击退距离和战每段冲刺距离一样，方向为被击退者对于战的方向。过程中再次热键释放终结技升龙劈</p></li>
<li><p>时序图:</p>

<p>  <img src="/images/ability-analyze-report/zhan_11005.png" alt="11005序列图" /></p></li>
</ul>


<h3 id="zhan_a">战普通攻击技能(11001)</h3>


<ul>
<li><p>时序图:</p>

<p>  <img src="/images/ability-analyze-report/zhan_11001.png" alt="11001序列图" /></p></li>
</ul>


<h2 id="sheng_skill">圣职业技能分析</h2>




<h3 id="sheng_q">Q-滑步</h3>


<ul>
<li><p>需求:</p>

<p>  在出现选择框后可以再次点击该技能，选择框会出现些许形状变化，此操作用于区分真身位置，默认状况是残影前冲攻击，再次点击则是真身前冲残影留在原地</p></li>
<li><p>时序图:</p>

<p>  <img src="/images/ability-analyze-report/sheng_41002.png" alt="41002序列图" /></p>

<p>  <h4 id="sheng_q1">天赋-距离</h4></p>

<ul>
<li>需求: 增加流影斩最大可移动距离25%</li>
<li><p>实现分析: 根据添加的技能属性Gis_ImproveDisRatio修改技能属性MaxDis值, 其过程如下时序图所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_q1.png" alt="gis_sheng_q1" /></p></li>
</ul>


<p>  <h4 id="sheng_q2">天赋-快速准备</h4></p>

<ul>
<li>需求: 当流影斩成功命中敌人时，会立即缩短流影斩一半的冷却时间</li>
<li><p>实现分析: 开启该天赋会添加新技能属性Gis_cutCDTime，当Q命中目标时尝试调用gis_sheng.on_cutdown_cdtime(),其过程如下图所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_q2.png" alt="gis_sheng_q2" /></p></li>
</ul>


<p>  <h4 id="sheng_q3">天赋-斩杀</h4></p>

<ul>
<li>需求: 当目标的当前血量少于20%，圣会尝试斩杀对方，造成基础攻击300%的伤害，只有真身出击时才可触发这个效果</li>
<li><p>实现分析: 开启该天赋会添加新技能属性Gis_lopHpRatio及Gis_lopDamRatio, 当对目标伤害结算前尝试调用gis_sheng.try_lop_target()增加伤害并伤害结算,其过程如下图所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_q3.png" alt="gis_sheng_q3" /></p></li>
</ul>
</li>
</ul>


<h3 id="sheng_w">W-三向分身</h3>


<ul>
<li><p>需求:</p>

<p>  出现方向的选择框并确认后，角色将朝选定的方向滑出，与角色呈120度夹角的另外2个方向会有2个残影以同样的姿势滑出</p></li>
<li><p>时序图:</p>

<p>  <img src="/images/ability-analyze-report/sheng_41003.png" alt="41003序列图" /></p>

<p>  <h4 id="sheng_w1">天赋-增强</h4></p>

<ul>
<li>需求: 使用三项分身之后，获得BUFF，圣及其残影的所有伤害提升30%，持续1.5秒</li>
<li><p>实现分析: 技能释放后调用gis_sheng.try_improve_all_damage()检查是否启用该天赋并添加增益BUFF, 其过程如下所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_w1.png" alt="gis_sheng_w1" /></p></li>
</ul>


<p>  <h4 id="sheng_w2">天赋-鬼步</h4></p>

<ul>
<li>需求: 被圣及其分身所碰到每个目标都将被减速30%，持续2秒</li>
<li><p>实现分析: 施法前调用gis_sheng.try_guibu()检查是否启用改天赋并添加碰撞触发器, 其过程如下所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_w2.png" alt="gis_sheng_w2" /></p></li>
</ul>


<p>  <h4 id="sheng_w3">天赋-反击</h4></p>

<ul>
<li>需求:使用三向分身后角色会获得反击状态2秒，在此状态持续时圣受到攻击时，残影会瞬移到攻击者身旁重击他使之昏迷1秒，触发这个效果后BUFF会消失</li>
<li><p>实现分析: 技能释放后调用gis_sheng.try_counterattack()检查是否启用该技能，如果启用添加反击BUFF，反击BUFF给宿主对象注册伤害触发器，当触发器触发时触发影子进行攻击，其过程如下所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_w3.png" alt="gis_sheng_w3" /></p></li>
</ul>
</li>
</ul>


<h3 id="sheng_e">E-连切</h3>


<ul>
<li><p>需求:</p>

<p> 按下快捷键，角色朝鼠标方向发动攻击，没按一次追加一次攻击，最多五次进入冷却时间（前面攻击长时间未按键也会进入冷却）,每次攻击会使目标定身1秒</p></li>
<li><p>时序图:</p>

<p>  <img src="/images/ability-analyze-report/sheng_41004.png" alt="41004序列图" /></p>

<p>  <h4 id="sheng_e1">天赋-影增强</h4></p>

<ul>
<li>需求: 连切引发的影子联动攻击的伤害提高50%</li>
<li><p>实现分析: 影子攻击前调用 gis_sheng.try_improve_blur_damage()提供技能伤害数值并返回恢复函数，攻击过程结束时执行恢复，其过程如下所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_e1.png" alt="gis_sheng_e1" /></p></li>
</ul>


<p>  <h4 id="sheng_e2">天赋-嗜血</h4></p>

<ul>
<li>需求: 圣的连切会让对方暴露弱点，使对方承受的圣的伤害提升30%，这个DEBUFF持续1.5秒</li>
<li><p>实现分析: 伤害结算前调用gis_sheng.try_be_bloodthirsty()给目标添加DEBUFF，其过程如下所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_e2.png" alt="gis_sheng_e2" /></p></li>
</ul>


<p>  <h4 id="sheng_e3">天赋-破绽</h4></p>

<ul>
<li>需求: 3次连续被击退的敌人将被击倒(2.5秒)</li>
<li><p>实现分析: 当发生3次攻击时调用gis_sheng.try_be_rip()给目标添加击倒DEBUFF，其过程如下所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_e3.png" alt="gis_sheng_e3" /></p></li>
</ul>
</li>
</ul>


<h3 id="sheng_r">R-绝影斩</h3>


<ul>
<li><p>需求:</p>

<p>  按键后出现锥形选择框, 选择方向后角色做出攻击准备姿势，在2秒后对区域发动沉重AOE攻击;同时圆形提示框内的残影会立即瞬移到箭头区域对区域内的敌人实施攻击，每个残影的攻击会使敌人昏迷0.5秒</p></li>
<li><p>时序图:</p>

<p>  <img src="/images/ability-analyze-report/sheng_41006.png" alt="41006序列图" /></p>

<p>  <h4 id="sheng_r1">天赋-追击强化</h4></p>

<ul>
<li>需求: 被残影追击攻击到的敌人将被昏迷</li>
<li><p>实现分析: 当影攻击到目标添加昏迷BUFF前调用gis_sheng.try_enhance_pursue()增加昏迷BUFF时间，其过程如下所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_r1.png" alt="gis_sheng_r1" /></p></li>
</ul>


<p>  <h4 id="sheng_r2">天赋-饮血</h4></p>

<ul>
<li>需求: 每击中一个敌人，会给圣叠加一层饮血BUFF，在10秒内回复最大血量的10%，最多可叠加5层</li>
<li><p>实现分析: 当攻击到目标伤害结算后调用gis_sheng.try_bebloodthirsty_with_healthregen()添加饮血BUFF，其过程如下所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_r2.png" alt="gis_sheng_r2" /></p></li>
</ul>


<p>  <h4 id="sheng_r3">天赋-反刃</h4></p>

<ul>
<li>需求: 到达目标点之后，圣再次施放乱舞从而返回起始位置，再次造成伤害</li>
<li><p>实现分析: 当技能释放后调用gis_sheng.try_anti_blade()返回lua闭包函数并执行该闭包，该闭包注册移动停止触发器，当移动停止后调整面向并调用skill_41006_cast()以达到再次施法，其过程如下图所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_r3.png" alt="gis_sheng_r3" /></p></li>
</ul>
</li>
</ul>


<h3 id="passive_talent">被动天赋</h3>




<h4 id="sheng_b1">会心一击</h4>


<ul>
<li>需求: 圣的普通攻击内置CD延长至2倍于目前时长，但会造成1.5倍于目前伤害的物理伤害</li>
<li>实现分析: 启用该天赋直接修改普通攻击技能CD时间, 示意图略</li>
</ul>


<h4 id="sheng_b2">替身术</h4>


<ul>
<li>需求: 只要还有自身残影在场，圣便不会死去，当此时圣受到致命伤害时，圣和残影位置互换，由残影来遭受此次伤害</li>
<li><p>实现分析: 启用该天赋时给玩家对象身上保存拦截死亡HOOK(<em>BTW: 由于结构的原因只能用这种取巧的方式实现</em>)，该HOOK函数主要功能是与周围最近的影子交换位置并取消其所受伤害减少的HP，其过程如下图所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_b2.png" alt="gis_sheng_b1" /></p></li>
</ul>


<h4 id="sheng_b3">残影精通</h4>


<ul>
<li>需求: 当残影由于受到伤害消失时，将回复圣能量30点，并会使残影位置上的敌人减速30%，持续1.5秒</li>
<li><p>实现分析: 启用该天赋时添加一个新技能41010(用于承载资源消耗)，当影子受伤消失时执行该技能的资源消耗并给周围敌对目标添加DEBUFF，其过程如下图所示:</p>

<p>  <img src="/images/ability-analyze-report/gis_sheng_b3.png" alt="gis_sheng_b3" /></p></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/06/24/ability-system-design/">Ability-system-design</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/03/lua-csv/">Parsing CSV Files in Lua</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/31/reverse-proxy/">ssh+nginx反向代理访问内网Web Service</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/29/ability-analyze-report/">技能脚本系统实现分析</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/youngtrips">@youngtrips</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'youngtrips',
            count: 8,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Tuz -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'logit';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
